#!/usr/bin/python
#
#   Author: Rohith
#   Date: 2015-04-23 11:04:20 +0100 (Thu, 23 Apr 2015)
#
#  vim:ts=2:sw=2:et
#

import requests

def main():
  module = AnsibleModule(
      argument_spec = dict(
          state     = dict(default='present', choices=['present', 'absent']),
          name      = dict(required=True),
          address   = dict(required=True),
          node_name = dict(default=""),
          token     = dict(default=""),
          tags      = dict(default=["master"]),
          consul    = dict(type='str', default='http://localhost:8500/'),
          port      = dict(type="int")
      )
  )
  endpoint = module.params['consul']+"v1/catalog/"
  register_url = endpoint + "register"
  deregister_url = endpoint + "deregister"
  register_payload = {
        "Node": module.params['node_name'] if module.params['node_name'] else module.params['address'],
        "Address": module.params['address'],
        "Service": {
           "Service": module.params['name'],
           "Tags": module.params['tags'],
           "Port": module.params['port']
         }
  }
  params_payload = { "token": module.params['token'] }

  if module.params['state'] == 'present':
    r = requests.post( register_url, data=json.dumps(register_payload), params=params_payload)
  elif module.params['state'] == 'absent':
    r = requests.post( deregister_url, data=json.dumps(register_payload), params=params_payload)
    
  if r.status_code == requests.codes.ok:
    module.exit_json(changed=(r.status_code == requests.codes.ok), responce=r.json())
  else:
    module.fail_json(msg=r.json())





from ansible.module_utils.basic import *
main()


